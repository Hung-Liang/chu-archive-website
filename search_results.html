<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>搜尋結果</title>
    <link rel="icon" href="./asset/icon.jpg" type="image/jpg" />
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 0;
        background-color: #f4f4f4;
        color: #333;
      }
      .container {
        max-width: 960px;
        margin: 20px auto;
        background-color: #fff;
        padding: 20px 30px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        position: relative;
        min-height: calc(100vh - 40px);
        box-sizing: border-box;
      }

      /* Images */
      .side-image {
        position: fixed;
        top: 50%;
        transform: translateY(-50%);
        z-index: -1;
        opacity: 0.3;
        max-height: 80vh;
        width: auto;
      }
      .side-image.left {
        left: 20px;
      }
      .side-image.right {
        right: 20px;
      }
      @media (max-width: 1200px) {
        .side-image {
          opacity: 0.15;
        }
      }
      @media (max-width: 992px) {
        .side-image {
          display: none;
        }
      }

      /* Buttons */
      .back-to-prev-button {
        position: absolute;
        top: 20px;
        left: 30px;
        display: inline-block;
        padding: 8px 15px;
        background-color: #6c757d;
        color: white;
        text-decoration: none;
        border-radius: 5px;
        transition: background-color 0.3s ease, transform 0.2s ease;
        font-weight: bold;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        font-size: 0.9em;
        z-index: 10;
      }
      .back-to-prev-button:hover {
        background-color: #5a6268;
        transform: translateY(-2px);
      }
      .back-to-prev-button:active {
        transform: translateY(0);
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
      }

      .top-right-buttons {
        position: absolute;
        top: 20px;
        right: 30px;
        display: flex;
        gap: 10px;
      }
      .action-button {
        display: inline-block;
        padding: 8px 15px;
        background-color: #3498db;
        color: white;
        text-decoration: none;
        border-radius: 5px;
        transition: background-color 0.3s ease, transform 0.2s ease;
        font-weight: bold;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        font-size: 0.9em;
      }
      .action-button:hover {
        background-color: #2980b9;
        transform: translateY(-2px);
      }
      .action-button:active {
        transform: translateY(0);
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
      }

      /* Search Specific Styles */
      #search-input-container {
        margin-top: 50px; /* Space for top buttons */
        text-align: center;
        margin-bottom: 20px;
      }
      #search-input {
        width: 80%;
        max-width: 500px;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 5px;
        font-size: 1em;
        box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1);
      }

      /* Video List Styles */
      #video-list {
        /* No longer a direct grid, content is grouped within */
        padding: 20px 0;
      }
      .video-group {
        margin-bottom: 30px;
      }
      .video-group h2 {
        color: #34495e;
        margin-top: 25px;
        padding-bottom: 5px;
        border-bottom: 2px solid #eee; /* Stronger border for categories */
      }
      .video-group h3 {
        color: #2980b9;
        margin-top: 15px;
        padding-bottom: 3px;
        border-bottom: 1px solid #eee; /* Lighter border for sub-categories */
      }
      .video-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
        gap: 20px;
        padding-top: 10px;
      }

      .video-item {
        background-color: #fff;
        border: 1px solid #ddd;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        text-align: center;
        transition: transform 0.2s ease-in-out;
      }
      .video-item:hover {
        transform: translateY(-5px);
      }
      .video-item a {
        display: block;
        padding-bottom: 10px;
        color: inherit;
        text-decoration: none;
      }
      .video-item img {
        max-width: 100%;
        height: auto;
        border-bottom: 1px solid #eee;
        margin-bottom: 10px;
      }
      .video-item .video-title {
        font-weight: bold;
        padding: 0 10px;
        margin-bottom: 5px;
        color: #333;
      }
      .video-item .video-meta {
        font-size: 0.85em;
        color: #777;
        padding: 0 10px;
        margin-top: -3px;
        margin-bottom: 5px;
      }
      .video-item .video-date {
        font-size: 0.9em;
        color: #666;
        padding: 0 10px;
      }

      /* Developer Info */
      .developer-info {
        position: absolute;
        bottom: 10px;
        right: 30px;
        font-size: 0.8em;
        color: #777;
      }
      .developer-info a {
        color: #777;
        text-decoration: underline;
        font-weight: normal;
      }
      .developer-info a:hover {
        color: #333;
      }
    </style>
  </head>
  <body>
    <img
      src="./asset/left_image.png"
      alt="Left Decor Image"
      class="side-image left"
    />
    <img
      src="./asset/right_image.png"
      alt="Right Decor Image"
      class="side-image right"
    />

    <div class="container">
      <a href="index.html" class="back-to-prev-button">← 回首頁</a>

      <div class="top-right-buttons">
        <a
          href="https://portaly.cc/commanderotaku"
          target="_blank"
          class="action-button"
          >關於宅宅</a
        >
      </div>

      <div id="search-input-container">
        <input
          type="text"
          id="search-input"
          placeholder="輸入直播標題關鍵字搜尋..."
        />
      </div>

      <div
        id="search-results-info"
        style="text-align: center; margin-bottom: 20px; color: #555"
      ></div>

      <div id="video-list"></div>

      <div class="developer-info">
        開發者:
        <a href="https://github.com/Hung-Liang" target="_blank">Hung-Liang</a>
      </div>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const searchInput = document.getElementById("search-input");
        const videoListContainer = document.getElementById("video-list");
        const searchResultsInfo = document.getElementById(
          "search-results-info"
        );

        let allVideosIndexData = [];

        const urlParams = new URLSearchParams(window.location.search);
        const initialSearchTerm = urlParams.get("query") || "";
        searchInput.value = initialSearchTerm;

        function getCategoryDisplayName(category) {
          if (category === "life") {
            return "直播回放";
          } else if (category === "gaming") {
            return "遊戲回放";
          }
          return "";
        }

        function getSubCategoryDisplayName(subCategory) {
          if (subCategory === "normal") {
            return "一般直播";
          } else if (subCategory === "member") {
            return "會限";
          }
          return "";
        }

        function renderSearchResults(results) {
          videoListContainer.innerHTML = "";

          if (results.length === 0) {
            videoListContainer.innerHTML =
              "<p style='text-align: center; margin-top: 50px;'>沒有找到符合條件的直播。</p>";
            searchResultsInfo.textContent = `共找到 0 筆結果。`;
            return;
          }

          const groupedVideos = {};
          results.forEach((video) => {
            const category = video.category;
            const subCategory = video.subCategory;

            if (!groupedVideos[category]) {
              groupedVideos[category] = {};
            }
            if (!groupedVideos[category][subCategory]) {
              groupedVideos[category][subCategory] = [];
            }
            groupedVideos[category][subCategory].push(video);
          });

          const orderedCategories = ["life", "gaming"];
          const orderedSubCategories = ["normal", "member"];

          let totalDisplayedVideos = 0;

          orderedCategories.forEach((categoryKey) => {
            if (groupedVideos[categoryKey]) {
              const categoryDiv = document.createElement("div");
              categoryDiv.className = "video-group";

              const categoryTitle = document.createElement("h2");
              categoryTitle.textContent = getCategoryDisplayName(categoryKey);
              categoryDiv.appendChild(categoryTitle);

              orderedSubCategories.forEach((subCategoryKey) => {
                if (groupedVideos[categoryKey][subCategoryKey]) {
                  const subCategoryDiv = document.createElement("div");
                  subCategoryDiv.className = "video-subgroup";

                  const subCategoryTitle = document.createElement("h3");
                  subCategoryTitle.textContent =
                    getSubCategoryDisplayName(subCategoryKey);
                  subCategoryDiv.appendChild(subCategoryTitle);

                  const videoGrid = document.createElement("div");
                  videoGrid.className = "video-grid";

                  groupedVideos[categoryKey][subCategoryKey].forEach(
                    (video) => {
                      const div = document.createElement("div");
                      div.className = "video-item";
                      const youtubeUrl = `https://www.youtube.com/watch?v=${video.videoId}`;

                      div.innerHTML = `
                            <a href="${youtubeUrl}" target="_blank">
                              <img src="${video.thumbnail}" alt="${
                        video.title
                      }" width="320">
                              <p class="video-title">${video.title}</p>
                              <p class="video-meta">
                                (${video.year}年${video.month}月)
                              </p>
                              <p class="video-date">${new Date(
                                video.publishedAt
                              ).toLocaleDateString()}</p>
                            </a>
                          `;
                      videoGrid.appendChild(div);
                      totalDisplayedVideos++;
                    }
                  );
                  subCategoryDiv.appendChild(videoGrid);
                  categoryDiv.appendChild(subCategoryDiv);
                }
              });
              videoListContainer.appendChild(categoryDiv);
            }
          });

          searchResultsInfo.textContent = `共找到 ${totalDisplayedVideos} 筆結果。`;
        }

        function performSearch() {
          const query = searchInput.value.toLowerCase().trim();
          if (query === "") {
            renderSearchResults([]);
            searchResultsInfo.textContent = "請輸入關鍵字開始搜尋...";
            return;
          }

          const filteredResults = allVideosIndexData.filter((video) =>
            video.title.toLowerCase().includes(query)
          );
          renderSearchResults(filteredResults);
        }

        fetch("./data/all_videos_index.json")
          .then((res) => {
            if (!res.ok) {
              throw new Error(
                `HTTP error! status: ${res.status} for ${res.url}`
              );
            }
            return res.json();
          })
          .then((data) => {
            allVideosIndexData = data;
            if (initialSearchTerm) {
              performSearch();
            } else {
              searchResultsInfo.textContent = "請輸入關鍵字開始搜尋...";
            }
          })
          .catch((error) => {
            console.error("Error fetching all_videos_index.json:", error);
            videoListContainer.innerHTML = `<p style='text-align: center; margin-top: 50px; color: red;'>無法載入搜尋資料，請稍後再試。</p><p style='text-align: center; color: red;'>錯誤: ${error.message}</p>`;
          });

        searchInput.addEventListener("input", performSearch);
      });
    </script>
  </body>
</html>
